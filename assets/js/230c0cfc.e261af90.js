"use strict";(self.webpackChunkkrateo_v_2_docs=self.webpackChunkkrateo_v_2_docs||[]).push([[864],{2632:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var s=n(7624),r=n(2172);const o={},i="Comprehensive Guide to Provider Generation with Krateo Operator Generator (KOG)",a={id:"key-concepts/kog/oasgen-provider-cheatsheet",title:"Comprehensive Guide to Provider Generation with Krateo Operator Generator (KOG)",description:"Table of Contents",source:"@site/docs/20-key-concepts/40-kog/11-oasgen-provider-cheatsheet.md",sourceDirName:"20-key-concepts/40-kog",slug:"/key-concepts/kog/oasgen-provider-cheatsheet",permalink:"/key-concepts/kog/oasgen-provider-cheatsheet",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:11,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"oasgen-provider",permalink:"/key-concepts/kog/oasgen-provider"},next:{title:"rest-dynamic-controller",permalink:"/key-concepts/kog/rest-dynamic-controller"}},c={},l=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"What to do when the OpenAPI Specification (OAS) is missing/incomplete or not at version 3.0+?",id:"what-to-do-when-the-openapi-specification-oas-is-missingincomplete-or-not-at-version-30",level:2},{value:"First Scenario: the service does not provide an OpenAPI Specification (OAS) but it exposes a REST API",id:"first-scenario-the-service-does-not-provide-an-openapi-specification-oas-but-it-exposes-a-rest-api",level:3},{value:"Second Scenario: the service does not expose a REST API but you have another way to interact with it (e.g., gRPC, GraphQL, etc.)",id:"second-scenario-the-service-does-not-expose-a-rest-api-but-you-have-another-way-to-interact-with-it-eg-grpc-graphql-etc",level:3},{value:"About OpenAPI Specification (OAS) 3.0+",id:"about-openapi-specification-oas-30",level:3},{value:"Supported authentication methods",id:"supported-authentication-methods",level:3},{value:"Simple Case: External APIs Compatible with K8s Resource Management",id:"simple-case-external-apis-compatible-with-k8s-resource-management",level:2},{value:"Step 1: Prepare Your OpenAPI Specification",id:"step-1-prepare-your-openapi-specification",level:3},{value:"Step 2: Prepare Kubernetes Environment",id:"step-2-prepare-kubernetes-environment",level:3},{value:"Step 3: Create RestDefinition for GitHub Repositories",id:"step-3-create-restdefinition-for-github-repositories",level:3},{value:"Wait for the CRD and Controller to be Created",id:"wait-for-the-crd-and-controller-to-be-created",level:4},{value:"Handling Schema Validation Issues",id:"handling-schema-validation-issues",level:4},{value:"Solution 1: Simplify Complex Types (Recommended)",id:"solution-1-simplify-complex-types-recommended",level:5},{value:"Solution 2: Use AdditionalProperties (Flexible but Less Safe)",id:"solution-2-use-additionalproperties-flexible-but-less-safe",level:5},{value:"Step 4: Verification Steps",id:"step-4-verification-steps",level:3},{value:"Step 5: Create the Custom Resources",id:"step-5-create-the-custom-resources",level:3},{value:"Step 6: Patch the Custom Resource",id:"step-6-patch-the-custom-resource",level:3},{value:"Step 7: Delete the Custom Resource",id:"step-7-delete-the-custom-resource",level:3},{value:"Extended Example: External API that requires a plugin to handle external API calls",id:"extended-example-external-api-that-requires-a-plugin-to-handle-external-api-calls",level:2},{value:"Step 1: Prepare Your OpenAPI Specification",id:"step-1-prepare-your-openapi-specification-1",level:3},{value:"Step 2: Prepare Kubernetes Environment",id:"step-2-prepare-kubernetes-environment-1",level:3},{value:"Step 3: Create RestDefinition for GitHub TeamRepos",id:"step-3-create-restdefinition-for-github-teamrepos",level:3},{value:"Wait for the CRD and Controller to be Created",id:"wait-for-the-crd-and-controller-to-be-created-1",level:3},{value:"Step 4: Verification Steps",id:"step-4-verification-steps-1",level:3},{value:"Step 5: Create the Custom Resource",id:"step-5-create-the-custom-resource",level:3},{value:"Step 6: Create the Web Service for TeamRepo Management",id:"step-6-create-the-web-service-for-teamrepo-management",level:3},{value:"Step 7: Update the RestDefinition to Use the Web Service",id:"step-7-update-the-restdefinition-to-use-the-web-service",level:3},{value:"Step 8: Update the Custom Resource",id:"step-8-update-the-custom-resource",level:3},{value:"Step 9: Delete the Custom Resource",id:"step-9-delete-the-custom-resource",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Common Issues",id:"common-issues",level:3},{value:"Detailed Solutions",id:"detailed-solutions",level:3},{value:"Debug Mode",id:"debug-mode",level:3}];function h(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"comprehensive-guide-to-provider-generation-with-krateo-operator-generator-kog",children:"Comprehensive Guide to Provider Generation with Krateo Operator Generator (KOG)"}),"\n",(0,s.jsx)(t.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.a,{href:"#comprehensive-guide-to-provider-generation-with-krateo-operator-generator-kog",children:"Comprehensive Guide to Provider Generation with Krateo Operator Generator (KOG)"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#prerequisites",children:"Prerequisites"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#what-to-do-when-the-openapi-specification-oas-is-missingincomplete-or-not-at-version-30",children:"What to do when the OpenAPI Specification (OAS) is missing/incomplete or not at version 3.0+?"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#simple-case-external-apis-compatible-with-k8s-resource-management",children:"Simple Case: External APIs Compatible with K8s Resource Management"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#extended-example-external-api-that-requires-a-plugin-to-handle-external-api-calls",children:"Extended Example: External API that requires a plugin to handle external API calls"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#best-practices",children:"Best Practices"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"#troubleshooting",children:"Troubleshooting"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Kubernetes cluster with Krateo installed"}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"kubectl"})," configured to access your cluster"]}),"\n",(0,s.jsx)(t.li,{children:"OpenAPI Specification (OAS) 3.0+ for your target API"}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"what-to-do-when-the-openapi-specification-oas-is-missingincomplete-or-not-at-version-30",children:"What to do when the OpenAPI Specification (OAS) is missing/incomplete or not at version 3.0+?"}),"\n",(0,s.jsx)(t.h3,{id:"first-scenario-the-service-does-not-provide-an-openapi-specification-oas-but-it-exposes-a-rest-api",children:"First Scenario: the service does not provide an OpenAPI Specification (OAS) but it exposes a REST API"}),"\n",(0,s.jsxs)(t.p,{children:["In this case, the way to go is to locate the endpoints you want to use in your generated controller from the API documentation of your service and manually create the OpenAPI Specification (OAS) 3.0+ for those endpoints. You can use tools like ",(0,s.jsx)(t.a,{href:"https://editor.swagger.io/",children:"Swagger Editor"})," to create and validate your OAS. This process seems tedious, but it is necessary for oasgen-provider to have a well-defined OAS to generate the CRDs and controllers correctly, and it is also useful for you to have a clear understanding of the API objects you want to manage."]}),"\n",(0,s.jsx)(t.h3,{id:"second-scenario-the-service-does-not-expose-a-rest-api-but-you-have-another-way-to-interact-with-it-eg-grpc-graphql-etc",children:"Second Scenario: the service does not expose a REST API but you have another way to interact with it (e.g., gRPC, GraphQL, etc.)"}),"\n",(0,s.jsx)(t.p,{children:"In this case, you can create a web service that acts as a bridge between the Krateo operator and the service you want to manage. The web service should implement the necessary logic to interact with the service and expose a REST API that is compatible with Kubernetes resource management. You can then use the OAS for the web service to generate the CRDs and controllers using oasgen-provider."}),"\n",(0,s.jsx)(t.h3,{id:"about-openapi-specification-oas-30",children:"About OpenAPI Specification (OAS) 3.0+"}),"\n",(0,s.jsx)(t.p,{children:"The OAS should include the following information:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Servers"}),": The ",(0,s.jsx)(t.code,{children:"servers"})," field (at root level of the OAS) should define the base URL for the API endpoints you want to use. This is important for the provider to know where to send requests. Note that you can override the base URL in the RestDefinition if you want to use a different URL for the API endpoints; refer ",(0,s.jsx)(t.a,{href:"#step-7-update-the-restdefinition-to-use-the-web-service",children:"here"})," for more information."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"API endpoints (paths)"}),": It should contain the paths for the API endpoints you want to use, including the HTTP methods (GET, POST, PUT, DELETE) and any parameters required by the endpoints. Note that it is important to specify whether the parameters are required or optional, as this will affect the generated CRDs and controllers. To learn more about how these paths are used by ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"}),", refer to the ",(0,s.jsx)(t.a,{href:"/key-concepts/kog/oasgen-provider#about-restdefinition-actions",children:"RestDefinition specifications"}),". Note that any endpoint should have predictable behavior, which means that the API should be idempotent and if a POST, PUT, PATCH, or DELETE request is made to an endpoint, this should be reflected in the response of the GET request to the same endpoint. This is important for the provider to know how to handle the requests and responses correctly so that the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," can manage the resources properly."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Request and response schemas"}),": It should define the request and response schemas for each endpoint, including the data types and any validation rules."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Authentication"}),": If the API requires authentication, you should define the security schemes in the ",(0,s.jsx)(t.code,{children:"components"})," section of the OAS. This is important for the provider to know how to authenticate requests to the API. If the API uses OAuth2 or other authentication methods, you should define them in the OAS. You can see supported authentication methods ",(0,s.jsx)(t.a,{href:"/key-concepts/kog/oasgen-provider#authentication",children:"here"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["Also note that any modification to the request or response schemas made by the API provider will require you to update the OAS accordingly, as the provider will generate the CRDs and controllers based on the OAS. Also consider removing the RestDefinition and recreating it with the updated OAS to ensure that the provider generates the correct CRDs and controllers (this is not necessary if you do not make changes to the request body or path parameters, as ",(0,s.jsx)(t.code,{children:"oasgen-provider"})," won't need to update the generated CRD)."]}),"\n",(0,s.jsx)(t.h3,{id:"supported-authentication-methods",children:"Supported authentication methods"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Bearer Token"}),": Use ",(0,s.jsx)(t.code,{children:"securitySchemes"})," in the OAS to define a bearer token scheme. This is common for APIs that require a token for authentication."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-diff",children:"openapi: 3.0.3\nservers:\n  - url: https://api.github.com\npaths:\n  ...\ncomponents:\n+ securitySchemes:\n+   oauth:\n+     type: http\n+     scheme: bearer\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Basic Authentication"}),": If the API uses basic authentication, you can define it in the OAS as follows:"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-diff",children:"openapi: 3.0.3\nservers:\n  - url: https://api.github.com\npaths:\n  ...\ncomponents:\n+ securitySchemes:\n+   basic:\n+     type: http\n+     scheme: basic\n"})}),"\n",(0,s.jsx)(t.h2,{id:"simple-case-external-apis-compatible-with-k8s-resource-management",children:"Simple Case: External APIs Compatible with K8s Resource Management"}),"\n",(0,s.jsx)(t.p,{children:"This guide provides a step-by-step approach to generating a provider for managing GitHub repositories using the Krateo Operator Generator (KOG). It assumes you have a basic understanding of Kubernetes and OpenAPI specifications."}),"\n",(0,s.jsx)(t.h3,{id:"step-1-prepare-your-openapi-specification",children:"Step 1: Prepare Your OpenAPI Specification"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Obtain or generate"})," the OAS for your target API"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Example: GitHub API OAS available at ",(0,s.jsx)(t.a,{href:"https://github.com/github/rest-api-description/blob/main/descriptions/ghes-3.9/ghes-3.9.yaml",children:"GitHub's REST API description"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Scope your OAS"})," to only include necessary endpoints:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Recommended for large APIs to reduce complexity"}),"\n",(0,s.jsxs)(t.li,{children:["Create separate files for different resource types (e.g., ",(0,s.jsx)(t.code,{children:"repositories.yaml"}),", ",(0,s.jsx)(t.code,{children:"teamrepo.yaml"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Add authentication"}),' information if missing from original OAS: (notes that components is a "root" element in OAS 3+)']}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-diff",children:"openapi: 3.0.3\nservers:\n  - url: https://api.github.com\npaths:\n  ...\ncomponents:\n+ securitySchemes:\n+   oauth:\n+     type: http\n+   scheme: bearer\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-2-prepare-kubernetes-environment",children:"Step 2: Prepare Kubernetes Environment"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Create a dedicated namespace:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create namespace gh-system\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:["Store your OAS as a ConfigMap: (In this example, we use a sample OAS for GitHub repositories stored in ",(0,s.jsx)(t.code,{children:"samples/cheatsheet/assets/repo.yaml"})," of this repository)"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create configmap repo --from-file=samples/cheatsheet/assets/repo.yaml -n gh-system\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"step-3-create-restdefinition-for-github-repositories",children:"Step 3: Create RestDefinition for GitHub Repositories"}),"\n",(0,s.jsxs)(t.p,{children:["In order to create a RestDefinition for GitHub repositories, you need to define the resource group, resource kind, and the verbs that the controller will support. The ",(0,s.jsx)(t.code,{children:"oasPath"})," should point to the ConfigMap containing your OAS. You can learn more about the ",(0,s.jsx)(t.code,{children:"RestDefinition"})," resource ",(0,s.jsx)(t.a,{href:"/key-concepts/kog/oasgen-provider#restdefinition-specifications",children:"here"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: swaggergen.krateo.io/v1alpha1\nkind: RestDefinition\nmetadata:\n  name: gh-repo\n  namespace: gh-system\nspec:\n  oasPath: configmap://gh-system/repo/repo.yaml\n  resourceGroup: github.kog.krateo.io\n  resource: \n    kind: Repo\n    identifiers:\n      - id \n      - name\n      - html_url\n    verbsDescription:\n    - action: create\n      method: POST\n      path: /orgs/{org}/repos\n    - action: delete\n      method: DELETE\n      path: /repos/{org}/{name}\n    - action: get\n      method: GET\n      path: /repos/{org}/{name}\n    - action: update\n      method: PATCH\n      path: /repos/{org}/{name}\nEOF\n"})}),"\n",(0,s.jsx)(t.h4,{id:"wait-for-the-crd-and-controller-to-be-created",children:"Wait for the CRD and Controller to be Created"}),"\n",(0,s.jsx)(t.p,{children:"You can check the status of the creation by running:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl wait restdefinition gh-repo --for condition=Ready=True --namespace gh-system --timeout=600s\n"})}),"\n",(0,s.jsx)(t.h4,{id:"handling-schema-validation-issues",children:"Handling Schema Validation Issues"}),"\n",(0,s.jsx)(t.p,{children:"Common error you might encounter:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Cannot create external resource [...] error: \"generating CRD: missing type in schema 'Title'\"\n"})}),"\n",(0,s.jsx)(t.h5,{id:"solution-1-simplify-complex-types-recommended",children:"Solution 1: Simplify Complex Types (Recommended)"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:"title:\n  type: string\n  description: The title of the issue.\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," Requires API wrapper for type conversion if original API expects different types."]}),"\n",(0,s.jsx)(t.h5,{id:"solution-2-use-additionalproperties-flexible-but-less-safe",children:"Solution 2: Use AdditionalProperties (Flexible but Less Safe)"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:"title:\n  additionalProperties: true\n  type: object\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," Bypasses validation but may cause runtime errors."]}),"\n",(0,s.jsx)(t.h3,{id:"step-4-verification-steps",children:"Step 4: Verification Steps"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Check CRD creation:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get crds | grep github.kog.krateo.io \n"})}),"\n",(0,s.jsx)(t.p,{children:"You should see:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:" bearerauths.github.kog.krateo.io           2025-06-13T08:28:06Z\n repoes.github.kog.krateo.io                2025-06-13T08:28:06Z\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["If you see ",(0,s.jsx)(t.code,{children:"bearerauths"})," and ",(0,s.jsx)(t.code,{children:"repoes"}),", the CRDs have been created successfully. The second CRD represents the ",(0,s.jsx)(t.code,{children:"repo"})," object. The first one is the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object, which is used to authenticate requests to the GitHub API."]}),"\n",(0,s.jsxs)(t.ol,{start:"2",children:["\n",(0,s.jsxs)(t.li,{children:["Verify controller pod:","\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get deploy -n gh-system\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["You should see a deployment named ",(0,s.jsx)(t.code,{children:"gh-repo-controller"}),", which is responsible for managing the ",(0,s.jsx)(t.code,{children:"Repo"})," resources."]}),"\n",(0,s.jsx)(t.p,{children:"If you see the deployment, you can check the logs of the controller pod to see if it is running correctly:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl logs deploy/gh-repo-controller -n gh-system\n"})}),"\n",(0,s.jsxs)(t.ol,{start:"3",children:["\n",(0,s.jsxs)(t.li,{children:["Check RestDefinition status:","\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get restdefinition -n gh-system\nkubectl describe restdefinition gh-repo -n gh-system\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"At this point you have a running operator able to handle GitHub repositories. You can create, update, and delete repositories using the custom resource."}),"\n",(0,s.jsx)(t.h3,{id:"step-5-create-the-custom-resources",children:"Step 5: Create the Custom Resources"}),"\n",(0,s.jsxs)(t.p,{children:["Create a custom resource for the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object. This is used to authenticate requests to the GitHub API. The ",(0,s.jsx)(t.code,{children:"bearerauth"})," object contains a reference to the token that is used to authenticate the requests. The token is stored in a Kubernetes secret."]}),"\n",(0,s.jsx)(t.p,{children:"So first, create a secret with your GitHub token: (generate a personal access token with the necessary permissions from your GitHub account settings)"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create secret generic gh-token --from-literal=token=<token> -n gh-system \n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: BearerAuth\nmetadata:\n  name: gh-bearer\n  namespace: gh-system\nspec:\n  tokenRef:\n    key: token\n    name: gh-token\n    namespace: gh-system\nEOF\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Create a custom resource for the ",(0,s.jsx)(t.code,{children:"Repo"})," object. This is used to create, update, and delete repositories in the GitHub API. The ",(0,s.jsx)(t.code,{children:"Repo"})," object contains the reference to the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object that is used to authenticate the requests."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: Repo\nmetadata:\n  name: gh-repo-1\n  namespace: gh-system\nspec:\n  authenticationRefs:\n    bearerAuthRef: gh-bearer \n  org: krateoplatformops-test\n  name: krateo-test-repo\n  description: A short description of the repository set by Krateo\n  visibility: public\n  has_issues: true\nEOF\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You will expect that the controller creates a repository in your GitHub account with the name ",(0,s.jsx)(t.code,{children:"krateo-test-repo"})," under the organization ",(0,s.jsx)(t.code,{children:"krateoplatformops-test"}),". You can check the status of the repository by running:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl describe repo.github.kog.krateo.io/gh-repo-1 -n gh-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"You should see a successful creation event, which indicates that the repository was created successfully."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Events:\n  Type     Reason                         Age                  From  Message\n  ----     ------                         ----                 ----  -------\n  Normal   CreatedExternalResource        6m30s                      Successfully requested creation of external resource\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Any edits to the ",(0,s.jsx)(t.code,{children:"Repo"})," custom resource will trigger the controller to update the corresponding repository in GitHub."]}),"\n",(0,s.jsx)(t.h3,{id:"step-6-patch-the-custom-resource",children:"Step 6: Patch the Custom Resource"}),"\n",(0,s.jsxs)(t.p,{children:["To update the repository, you can patch the ",(0,s.jsx)(t.code,{children:"Repo"})," custom resource. For example, to change the description of the repository:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: Repo\nmetadata:\n  name: gh-repo-1\n  namespace: gh-system\nspec:\n  authenticationRefs:\n    bearerAuthRef: gh-bearer \n  org: krateoplatformops-test\n  name: krateo-test-repo\n  description: A new description of the repository set by Krateo\n  visibility: public\n  has_issues: true\nEOF\n"})}),"\n",(0,s.jsx)(t.p,{children:"This will trigger the controller to update the repository in GitHub with the new description."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl describe repo.github.kog.krateo.io/gh-repo-1 -n gh-system\n```{{exec}}\n\nYou should see an event for the Repo resource indicating that the external resource was updated successfully:\n\n```text\nEvents:\n  Type     Reason                         Age                  From  Message\n  ----     ------                         ----                 ----  -------\n  Normal   UpdatedExternalResource        10s                       Successfully requested update of external resource\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-7-delete-the-custom-resource",children:"Step 7: Delete the Custom Resource"}),"\n",(0,s.jsxs)(t.p,{children:["To delete the repository, you can delete the ",(0,s.jsx)(t.code,{children:"Repo"})," custom resource:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl delete repo.github.kog.krateo.io gh-repo-1 -n gh-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"This will trigger the controller to delete the corresponding repository in GitHub.\nYou should see an event for the Repo resource indicating that the external resource was deleted successfully:"}),"\n",(0,s.jsx)(t.p,{children:"You can check the status of the deletion by running:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get events --sort-by='.lastTimestamp' -n gh-system | grep repo/gh-repo-1\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Events:\n  Type     Reason                         Age                  From  Message\n  ----     ------                         ----                 ----  -------\n  Normal   DeletedExternalResource      repo/gh-repo-1        Successfully requested deletion of external resource\n"})}),"\n",(0,s.jsx)(t.h2,{id:"extended-example-external-api-that-requires-a-plugin-to-handle-external-api-calls",children:"Extended Example: External API that requires a plugin to handle external API calls"}),"\n",(0,s.jsx)(t.p,{children:"This example demonstrates how to create a Krateo provider for managing GitHub repositories using an external web service to handle API calls. This approach is useful when the API isn't directly compatible with Kubernetes resource management or requires additional processing."}),"\n",(0,s.jsx)(t.p,{children:"For an API to be compatible with Kubernetes resource management, it should create, update, and delete resources in a way that is similar to Kubernetes resources. This means the API should support the same operations as Kubernetes resources, such as create, update, delete, and get. If the API doesn't support these operations or requires additional processing, you can use an external web service to handle the API calls."}),"\n",(0,s.jsx)(t.p,{children:"This example assumes you have a basic understanding of Kubernetes, OpenAPI specifications, and web service development."}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," In this example, we'll develop a web service that handles API calls to the GitHub API. The web service will be responsible for creating, updating, and deleting repositories in GitHub. While this example uses Go, you can use any programming language and framework you're comfortable with."]}),"\n",(0,s.jsx)(t.h3,{id:"step-1-prepare-your-openapi-specification-1",children:"Step 1: Prepare Your OpenAPI Specification"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Obtain or generate"})," the OAS for your target API"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Example: GitHub API OAS available at ",(0,s.jsx)(t.a,{href:"https://github.com/github/rest-api-description/blob/main/descriptions/ghes-3.9/ghes-3.9.yaml",children:"GitHub's REST API description"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Scope your OAS"})," to only include necessary endpoints:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Recommended for large APIs to reduce complexity"}),"\n",(0,s.jsxs)(t.li,{children:["Create separate files for different resource types (e.g., ",(0,s.jsx)(t.code,{children:"repositories.yaml"}),", ",(0,s.jsx)(t.code,{children:"teamrepo.yaml"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Add authentication"})," information if missing from the original OAS:"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-diff",children:"openapi: 3.0.3\nservers:\n  - url: https://api.github.com\npaths:\n  ...\ncomponents:\n+ securitySchemes:\n+   oauth:\n+     type: http\n+   scheme: bearer\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-2-prepare-kubernetes-environment-1",children:"Step 2: Prepare Kubernetes Environment"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Create a dedicated namespace:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create namespace gh-system\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:"Store your OAS as a ConfigMap (in this example, we use a sample OAS for GitHub teamrepos stored in assets of this repository):"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create configmap teamrepo --from-file=samples/cheatsheet/assets/teamrepo_no_ws.yaml -n gh-system\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"step-3-create-restdefinition-for-github-teamrepos",children:"Step 3: Create RestDefinition for GitHub TeamRepos"}),"\n",(0,s.jsxs)(t.p,{children:["In order to create a RestDefinition for GitHub teamrepos, you need to define the resource group, resource kind, and the verbs that the controller will support. The ",(0,s.jsx)(t.code,{children:"oasPath"})," should point to the ConfigMap containing your OAS. You can learn more about the ",(0,s.jsx)(t.code,{children:"RestDefinition"})," resource ",(0,s.jsx)(t.a,{href:"/key-concepts/kog/oasgen-provider#restdefinition-specifications",children:"here"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: swaggergen.krateo.io/v1alpha1\nkind: RestDefinition\nmetadata:\n  name: gh-teamrepo\n  namespace: gh-system\nspec:\n  oasPath: configmap://gh-system/teamrepo/teamrepo_no_ws.yaml\n  resourceGroup: github.kog.krateo.io\n  resource: \n    kind: TeamRepo\n    identifiers:\n      - id \n      - name\n      - full_name\n      - permission\n    verbsDescription:\n    - action: create\n      method: PUT\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: delete\n      method: DELETE\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: get\n      method: GET\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: update\n      method: PUT\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\nEOF\n"})}),"\n",(0,s.jsx)(t.h3,{id:"wait-for-the-crd-and-controller-to-be-created-1",children:"Wait for the CRD and Controller to be Created"}),"\n",(0,s.jsx)(t.p,{children:"You can check the creation status by running:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl wait restdefinition gh-teamrepo --for condition=Ready=True --namespace gh-system --timeout=600s\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-4-verification-steps-1",children:"Step 4: Verification Steps"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Check CRD creation:"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get crds | grep github.kog.krateo.io \n"})}),"\n",(0,s.jsx)(t.p,{children:"You should see:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"bearerauths.github.kog.krateo.io           2025-06-13T08:28:06Z\nteamrepos.github.kog.krateo.io             2025-06-13T08:28:06Z\n"})}),"\n",(0,s.jsxs)(t.p,{children:["If you see ",(0,s.jsx)(t.code,{children:"bearerauths"})," and ",(0,s.jsx)(t.code,{children:"teamrepos"}),", the CRDs are created successfully. The second CRD represents the ",(0,s.jsx)(t.code,{children:"teamrepo"})," object, while the first one is the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object used to authenticate requests to the GitHub API."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," If you've previously created the ",(0,s.jsx)(t.code,{children:"repo"})," RestDefinition, you'll also see the ",(0,s.jsx)(t.code,{children:"repoes.github.kog.krateo.io"})," CRD. However, the ",(0,s.jsx)(t.code,{children:"bearerauths.github.kog.krateo.io"})," CRD is shared between RestDefinitions because they use the same group and authentication scheme."]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Verify controller deployment:"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get deploy -n gh-system\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You should see a deployment named ",(0,s.jsx)(t.code,{children:"gh-teamrepo-controller"})," responsible for managing the ",(0,s.jsx)(t.code,{children:"teamrepo"})," resources."]}),"\n",(0,s.jsx)(t.p,{children:"If you see the deployment, check the controller pod logs to verify it's running correctly:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl logs deploy/gh-teamrepo-controller -n gh-system\n"})}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Check RestDefinition status:"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get restdefinition -n gh-system\nkubectl describe restdefinition gh-teamrepo -n gh-system\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"At this point, you have a running operator capable of handling GitHub teamrepos. You can create, update, and delete teamrepos using the custom resource."}),"\n",(0,s.jsx)(t.h3,{id:"step-5-create-the-custom-resource",children:"Step 5: Create the Custom Resource"}),"\n",(0,s.jsxs)(t.p,{children:["Create a custom resource for the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object. (You can skip the secret and bearerAuth creation if you've completed the ",(0,s.jsx)(t.code,{children:"repo"})," tutorial in the previous section.) This is used to authenticate requests to the GitHub API. The ",(0,s.jsx)(t.code,{children:"bearerauth"})," object contains a reference to the token used for authentication, which is stored in a Kubernetes secret."]}),"\n",(0,s.jsx)(t.p,{children:"First, create a secret with your GitHub token (generate a personal access token with the necessary permissions from your GitHub account settings):"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create secret generic gh-token --from-literal=token=<your-token> -n gh-system \n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: BearerAuth\nmetadata:\n  name: gh-bearer\n  namespace: gh-system\nspec:\n  tokenRef:\n    key: token\n    name: gh-token\n    namespace: gh-system\nEOF\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Create a custom resource for the ",(0,s.jsx)(t.code,{children:"teamrepo"})," object. This is used to create, update, and delete teamrepos in the GitHub API. The ",(0,s.jsx)(t.code,{children:"teamrepo"})," object contains a reference to the ",(0,s.jsx)(t.code,{children:"bearerauth"})," object used for authentication:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: TeamRepo\nmetadata:\n  name: test-teamrepo\n  namespace: gh-system\nspec:\n  authenticationRefs:\n    bearerAuthRef: gh-bearer\n  org: krateoplatformops-test\n  owner: krateoplatformops-test\n  team_slug: prova\n  repo: test-teamrepo\n  permission: admin\nEOF\n"})}),"\n",(0,s.jsx)(t.p,{children:'The controller should add the GitHub team "prova" to the repository "test-teamrepo" in the organization "krateoplatformops-test" with "admin" permission. Check the teamrepo creation status by running:'}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl describe teamrepo.github.kog.krateo.io/test-teamrepo -n gh-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"You should see the teamrepo creation status and any errors that occurred during the process."}),"\n",(0,s.jsxs)(t.p,{children:["In this case, you should see that the teamrepo was created successfully with status ",(0,s.jsx)(t.code,{children:"Ready"}),": ",(0,s.jsx)(t.code,{children:"True"}),", but you should also notice that the ",(0,s.jsx)(t.code,{children:"Message"}),' field states "Resource is assumed to be up-to-date. Returned body is nil."']}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"...\nStatus:\n  Conditions:\n    Last Transition Time:  2025-06-18T14:13:03Z\n    Message:               Resource is assumed to be up-to-date. Returned body is nil.\n    Reason:                Available\n    Status:                True\n    Type:                  Ready\nEvents:\n  Type    Reason                   Age   From  Message\n  ----    ------                   ----  ----  -------\n  Normal  CreatedExternalResource  86s         Successfully requested creation of external resource\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This message indicates that the controller was able to create the teamrepo in GitHub, but the response body from the GitHub API is nil. This is expected behavior as described ",(0,s.jsx)(t.a,{href:"https://docs.github.com/en/rest/teams/teams?apiVersion=2022-11-28#check-team-permissions-for-a-repository",children:"here"}),". According to the GitHub API documentation, the response body for this endpoint is empty when the request is successful but the accept header isn't set to ",(0,s.jsx)(t.code,{children:"application/vnd.github.v3+json"}),". This is a known limitation of the GitHub API, and it's not possible to change the accept header for requests made by the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," directly."]}),"\n",(0,s.jsxs)(t.p,{children:["To add the header to the request, we need to implement a web service that handles API calls to the GitHub API. The web service will be responsible for adding the header to the request and returning the response body, since the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," doesn't support adding headers to requests made to external APIs."]}),"\n",(0,s.jsx)(t.h3,{id:"step-6-create-the-web-service-for-teamrepo-management",children:"Step 6: Create the Web Service for TeamRepo Management"}),"\n",(0,s.jsxs)(t.p,{children:["At this point, we need to implement a web service that handles API calls to the GitHub API. In this case, the web service will only be responsible for the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos, because the ",(0,s.jsx)(t.code,{children:"create"}),", ",(0,s.jsx)(t.code,{children:"delete"}),", and ",(0,s.jsx)(t.code,{children:"update"})," operations are handled directly by the controller."]}),"\n",(0,s.jsxs)(t.p,{children:["To handle this case, we've implemented a web service that handles the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos. You can check the implementation at this link: ",(0,s.jsx)(t.a,{href:"https://github.com/krateoplatformops/github-rest-dynamic-controller-plugin/blob/main/internal/handlers/repo/repo.go",children:"GitHub Plugin for rest-dynamic-controller"}),". You can also check the ",(0,s.jsx)(t.a,{href:"https://github.com/krateoplatformops/github-rest-dynamic-controller-plugin/blob/main/README.md",children:"README"})," for more information on running and why it has been implemented."]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Note:"})," ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," to check if the CR is up-to-date or not, checks the fields in the CR (spec and status) against the fields in the response body from the external API. It compare the fields at the same level, so if the response fields are more nested than the fields in the CR, it will not be able to compare them correctly. This is why we need to implement a web service that returns the response body with the same structure as the CR. This problem is quite common and a specific solution has been described ",(0,s.jsx)(t.a,{href:"https://github.com/krateoplatformops/github-rest-dynamic-controller-plugin/blob/main/README.md#2-get-team-permission-in-a-repository",children:"here"})]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: github-provider-plugin-krateo\n  namespace: default\nspec:\n  selector:\n    app: github-provider-plugin-krateo\n  ports:\n    - protocol: TCP\n      port: 8080\n      targetPort: 8080\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: github-provider-plugin-krateo\n  namespace: default\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: github-provider-plugin-krateo\n  template:\n    metadata:\n      labels:\n        app: github-provider-plugin-krateo\n    spec:\n      containers:\n        - name: github-provider-plugin-krateo\n          image: ghcr.io/krateoplatformops/github-rest-dynamic-controller-plugin:0.0.2\n          ports:\n            - containerPort: 8080\nEOF\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-7-update-the-restdefinition-to-use-the-web-service",children:"Step 7: Update the RestDefinition to Use the Web Service"}),"\n",(0,s.jsxs)(t.p,{children:["Now we need to tell the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," to use the web service to handle the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos. We can do this by adding the plugin URL to the OpenAPI specification of the ",(0,s.jsx)(t.code,{children:"teamrepo"})," RestDefinition. We can accomplish this by adding the ",(0,s.jsx)(t.code,{children:"servers"})," field to the endpoint in the OpenAPI specification (",(0,s.jsx)(t.a,{href:"https://swagger.io/docs/specification/v3_0/api-host-and-base-path/#overriding-servers",children:"https://swagger.io/docs/specification/v3_0/api-host-and-base-path/#overriding-servers"}),"). In this case, the URL will be ",(0,s.jsx)(t.code,{children:"http://github-provider-plugin-krateo.default.svc.cluster.local:8080"})," because the web service is running in the ",(0,s.jsx)(t.code,{children:"default"})," namespace with the service name ",(0,s.jsx)(t.code,{children:"github-provider-plugin-krateo"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Let's create a new configmap with the updated OpenAPI specification:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl create configmap teamrepo-ws --from-file=samples/cheatsheet/assets/teamrepo_ws.yaml -n gh-system\n"})}),"\n",(0,s.jsxs)(t.p,{children:["As you can see, the new OpenAPI specification also includes another endpoint for the ",(0,s.jsx)(t.code,{children:"get"})," operation that points to the web service URL:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",children:'...\npaths:\n  "/teamrepository/orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}":\n    get:\n      servers:\n      - url: http://github-provider-plugin-krateo.default.svc.cluster.local:8080\n...\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This means that when the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," handles the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos, it will call the web service instead of the GitHub API directly. The web service will then add the necessary headers to the request and return the response body."]}),"\n",(0,s.jsxs)(t.p,{children:["Now we need to update the ",(0,s.jsx)(t.code,{children:"RestDefinition"})," to use the new configmap:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: swaggergen.krateo.io/v1alpha1\nkind: RestDefinition\nmetadata:\n  name: gh-teamrepo\n  namespace: gh-system\nspec:\n  oasPath: configmap://gh-system/teamrepo-ws/teamrepo_ws.yaml\n  resourceGroup: github.kog.krateo.io\n  resource: \n    kind: TeamRepo\n    identifiers:\n      - id\n      - permissions\n      - html_url\n    verbsDescription:\n    - action: create\n      method: PUT\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: delete\n      method: DELETE\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: get\n      method: GET\n      path: /teamrepository/orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\n    - action: update\n      method: PUT\n      path: /orgs/{org}/teams/{team_slug}/repos/{owner}/{repo}\nEOF\n"})}),"\n",(0,s.jsxs)(t.p,{children:["We expect the controller to update the RestDefinition and start using the web service to handle the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos."]}),"\n",(0,s.jsxs)(t.p,{children:["At this point, the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," should be able to handle the ",(0,s.jsx)(t.code,{children:"get"})," operation for teamrepos using the web service. You can check the status of the TeamRepo resource by running:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl describe teamrepo.github.kog.krateo.io/test-teamrepo -n gh-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"You should see that the message field is now empty, which means the RestDefinition is ready and correctly observed by the controller. (Notes that you should wait for the reconciliation loop to run, which may take a few minutes.)"}),"\n",(0,s.jsx)(t.h3,{id:"step-8-update-the-custom-resource",children:"Step 8: Update the Custom Resource"}),"\n",(0,s.jsx)(t.p,{children:"To check if the remote resource changes along with the custom resource, you can run the following command to change the teamrepo's permission:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"cat <<EOF | kubectl apply -f -\napiVersion: github.kog.krateo.io/v1alpha1\nkind: TeamRepo\nmetadata:\n  name: test-teamrepo\n  namespace: gh-system\nspec:\n  authenticationRefs:\n    bearerAuthRef: gh-bearer\n  org: krateoplatformops-test\n  owner: krateoplatformops-test\n  team_slug: prova\n  repo: test-teamrepo\n  permission: pull\nEOF\n"})}),"\n",(0,s.jsx)(t.p,{children:"After a few seconds, you should see that the teamrepo's permission is updated in GitHub. Check the teamrepo status by running:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl describe teamrepo.github.kog.krateo.io/test-teamrepo -n gh-system\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You should see that the permission is updated to ",(0,s.jsx)(t.code,{children:"pull"}),", the status is set to ",(0,s.jsx)(t.code,{children:"Ready"}),": ",(0,s.jsx)(t.code,{children:"True"}),", and events indicate that the external resource was updated successfully:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Events:\n  Type     Reason                         Age                  From  Message\n  ----     ------                         ----                 ----  -------\n  Normal   UpdatedExternalResource        77s (x2 over 80s)             Successfully requested update of external resource\n"})}),"\n",(0,s.jsx)(t.h3,{id:"step-9-delete-the-custom-resource",children:"Step 9: Delete the Custom Resource"}),"\n",(0,s.jsxs)(t.p,{children:["To delete the teamrepo, you can delete the ",(0,s.jsx)(t.code,{children:"TeamRepo"})," custom resource:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl delete teamrepo.github.kog.krateo.io test-teamrepo -n gh-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"This will trigger the controller to delete the corresponding teamrepo in GitHub."}),"\n",(0,s.jsx)(t.p,{children:"You should see an event for the TeamRepo resource indicating that the external resource was deleted successfully. Check the deletion status by running:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"kubectl get events --sort-by='.lastTimestamp' -n gh-system | grep teamrepo/test-teamrepo\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-text",children:"Events:\n  Type     Reason                         Age                  From  Message\n  ----     ------                         ----                 ----  -------\n  Normal   DeletedExternalResource      teamrepo/test-teamrepo        Successfully requested deletion of external resource\n"})}),"\n",(0,s.jsx)(t.p,{children:"This indicates that the teamrepo was deleted successfully from GitHub. You can manually check the GitHub UI to confirm that the teamrepo is no longer present."}),"\n",(0,s.jsx)(t.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Incremental Development"}),": Start with a small subset of endpoints"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Monitoring"}),": Set up alerts for the ",(0,s.jsx)(t.code,{children:"rest-dynamic-controller"})," pods"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Documentation"}),": Maintain a changelog for your OAS modifications"]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(t.h3,{id:"common-issues",children:"Common Issues"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"CRD not created"}),": Check RestDefinition status and controller logs"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Authentication issues"}),": Verify securitySchemes in OAS match actual API requirements"]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Type errors"}),": Ensure all fields have proper type definitions"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"detailed-solutions",children:"Detailed Solutions"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Conversion from OAS 2.0 to 3.0:"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Use ",(0,s.jsx)(t.a,{href:"https://editor.swagger.io",children:"Swagger Editor"})," for conversion"]}),"\n",(0,s.jsx)(t.li,{children:"Manually review and correct any conversion issues"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Inconsistent API interfaces:"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Create a web service wrapper to normalize interfaces"}),"\n",(0,s.jsxs)(t.li,{children:["Example implementations available in ",(0,s.jsx)(t.a,{href:"https://github.com/krateoplatformops/azuredevops-oas3-plugin",children:"Java"})," and ",(0,s.jsx)(t.a,{href:"https://github.com/krateoplatformops/github-oas3-plugin",children:"Python"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(t.li,{children:["\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Authentication issues:"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Verify secret references in BasicAuth CRs"}),"\n",(0,s.jsx)(t.li,{children:"Check network connectivity to API endpoints"}),"\n",(0,s.jsx)(t.li,{children:"Enable verbose logging with annotations (see below)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.h3,{id:"debug-mode",children:"Debug Mode"}),"\n",(0,s.jsxs)(t.p,{children:["To troubleshoot Krateo controllers, add the annotation ",(0,s.jsx)(t.code,{children:'krateo.io/connector-verbose: "true"'})," to the CR you want to debug. This enables verbose logging for the controller and helps you understand what's happening under the hood."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Examples:"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Adding this annotation to a ",(0,s.jsx)(t.code,{children:"RestDefinition"})," will help you understand what happens when the controller tries to create the CRD and controller for the RestDefinition"]}),"\n",(0,s.jsxs)(t.li,{children:["Adding it to a ",(0,s.jsx)(t.code,{children:"Repo"})," or ",(0,s.jsx)(t.code,{children:"TeamRepo"})," CR will help you understand what happens when the controller tries to create, update, or delete the external resource, and will log any HTTP requests and responses made to the external API"]}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,r.M)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},2172:(e,t,n)=>{n.d(t,{I:()=>a,M:()=>i});var s=n(1504);const r={},o=s.createContext(r);function i(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);