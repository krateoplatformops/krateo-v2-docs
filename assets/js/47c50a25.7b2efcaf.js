"use strict";(self.webpackChunkkrateo_v_2_docs=self.webpackChunkkrateo_v_2_docs||[]).push([[676],{2580:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var t=r(7624),o=r(2172);const i={},a="finops-operator-exporter",s={id:"key-concepts/kcf/finops-operator-exporter",title:"finops-operator-exporter",description:"This repository is part of the wider exporting architecture for the Krateo Composable FinOps and manages the exporting from API endpoints of FOCUS cost reports.",source:"@site/docs/20-key-concepts/30-kcf/10-finops-operator-exporter.md",sourceDirName:"20-key-concepts/30-kcf",slug:"/key-concepts/kcf/finops-operator-exporter",permalink:"/key-concepts/kcf/finops-operator-exporter",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"authn",permalink:"/key-concepts/kcp/authn"},next:{title:"finops-operator-scraper",permalink:"/key-concepts/kcf/finops-operator-scraper"}},c={},p=[{value:"Summary",id:"summary",level:2},{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Examples",id:"examples",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Installation with HELM",id:"installation-with-helm",level:3},{value:"Dependencies",id:"dependencies",level:3},{value:"Bearer-token for Azure",id:"bearer-token-for-azure",level:3}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"finops-operator-exporter",children:"finops-operator-exporter"}),"\n",(0,t.jsxs)(n.p,{children:["This repository is part of the wider exporting architecture for the Krateo Composable FinOps and manages the exporting from API endpoints of FOCUS cost reports.\nAdditional information can be read in the summary document ",(0,t.jsx)(n.a,{href:"https://github.com/krateoplatformops/finops-operator-exporter/blob/main/resources/Krateo_Composable_FinOps___Full.pdf",children:"here"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#overview",children:"Overview"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#architecture",children:"Architecture"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#examples",children:"Examples"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"#configuration",children:"Configuration"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:'This finops-operator-exporter is tasked with the creation of a generic exporting pipeline, according to the description given in a Custom Resource (CR). After the creation of the CR, the operator reads the "exporting" configuration and creates three resources: a deployment with a generic prometheus exporter inside, a configmap containing the configuration and a service that exposes the deployment. The given endpoint is supposed to be a CSV file containing a FOCUS report. Then, it creates a new CR for the FinOps Operator Scraper, which starts a generic scraper to upload the data to a database.'}),"\n",(0,t.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Krateo Composable FinOps Operator Exporter",src:r(1592).c+"",width:"1975",height:"683"})}),"\n",(0,t.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: finops.krateo.io/v1\nkind: DatabaseConfig\nmetadata:\n  name: # DatabaseConfig name\n  namespace: # DatabaseConfig namespace\nspec:\n  username: # username string\n  passwordSecretRef: # object reference to secret with password\n    name: # secret name\n    namespace: # secret namespace\n    key: # secret key\n---\napiVersion: finops.krateo.io/v1\nkind: ExporterScraperConfig\nmetadata:\n  name: # ExporterScraperConfig name\n  namespace: # ExporterScraperConfig namespace\nspec:\n  exporterConfig: # same as krateoplatformops/finops-prometheus-exporter-generic\n    provider: \n      name: # name of the provider config\n      namespace: # namespace of the provider config\n    url: # url including http/https of the CSV-based API to export, parts with <varName> are taken from additionalVariables: http://<varName> -> http://sample \n    requireAuthentication: # true/false\n    authenticationMethod: # one of: bearer-token, cert-file\n    # bearerToken: # optional, if "authenticationMethod: bearer-token", objectRef to a standard Kubernetes secret with specified key\n    #  name: # secret name\n    #  namespace: # secret namespace\n    #  key: # key of the secret\n    # metricType: # optional, one of: cost, resource; default value: resource\n    pollingIntervalHours: # int\n    additionalVariables:\n      varName: sample\n      # Variables whose value only contains uppercase letters are taken from environment variables\n      # FROM_THE_ENVIRONMENT must be the name of an environment variable inside the target exporter container\n      envExample: FROM_THE_ENVIRONMENT\n  scraperConfig: # configuration for krateoplatformops/finops-operator-scraper\n    tableName: # tableName in the database to upload the data to\n    # url: # path to the exporter, optional (if missing, its taken from the exporter)\n    pollingIntervalHours: # int\n    scraperDatabaseConfigRef: # See above kind DatabaseConfig\n      name: # name of the databaseConfigRef CR \n      namespace: # namespace of the databaseConfigRef CR\n'})}),"\n",(0,t.jsxs)(n.p,{children:["If the field ",(0,t.jsx)(n.code,{children:"metricType"})," is set to ",(0,t.jsx)(n.code,{children:"cost"}),", then the API in ",(0,t.jsx)(n.code,{children:"url"})," must expose a FOCUS report in a CSV file. Otherwise, if set to ",(0,t.jsx)(n.code,{children:"resource"}),", it must expose usage metrics according to the JSON/OPENAPI schema in the folder resources and the field ",(0,t.jsx)(n.code,{children:"additionalVariables"})," must contain a field ",(0,t.jsx)(n.code,{children:"ResourceId"})," with the identifier of the resources to be used in the database as external key to reference the cost metric from the usage metric (i.e., the same as the field ",(0,t.jsx)(n.code,{children:"resourceId"})," of the focusConfig CR)."]}),"\n",(0,t.jsxs)(n.p,{children:["The field ",(0,t.jsx)(n.code,{children:"spec.scraperConfig.url"})," can be left empty if the exporter and scraper are both configured. The operator will compile this field automatically."]}),"\n",(0,t.jsxs)(n.p,{children:["The CR can be configured to include a ",(0,t.jsx)(n.code,{children:"provider"}),", which is an object reference to a set of CRs that identify, for a given provider, which resources and which additional metrics should be exported and scraped. For example, for the CPU usage of virtual machines on Azure:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: finops.krateo.io/v1\nkind: ProviderConfig\nmetadata:\n  name: azure\n  namespace: finops\nspec:\n  resourcesRef:\n  - name: azure-virtual-machines\n    namespace: finops\n- - -\napiVersion: finops.krateo.io/v1\nkind: ResourceConfig\nmetadata:\n  name: azure-virtual-machines\n  namespace: finops\nspec:\n  resourceFocusName: Virtual machine\n  metricsRef:\n  - name: azure-vm-cpu-usage\n    namespace: finops\n- - -\napiVersion: finops.krateo.io/v1\nkind: MetricConfig\nmetadata:\n  name: azure-vm-cpu-usage\n  namespace: finops\nspec:\n  metricName: Percentage CPU\n  endpoint:\n    resourceSuffix: /providers/microsoft.insights/metrics?api-version=2023-10-01\n  timespan: month\n  interval: PT15M\n"})}),"\n",(0,t.jsxs)(n.p,{children:["For these metrics, the exporting/scraping pipeline is automatically started and the field ",(0,t.jsx)(n.code,{children:"metricType"})," is automatically populated."]}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.p,{children:"To start the exporting process, see the examples section. The configuration sample includes the database-config CR."}),"\n",(0,t.jsxs)(n.p,{children:["The exporter container is created in the namespace of the CR. The exporter container looks for a secret in the CR namespace called ",(0,t.jsx)(n.code,{children:"registry-credentials"}),", configurable in the HELM chart."]}),"\n",(0,t.jsxs)(n.p,{children:["The FOCUS data needs to be in the CSV format and the ",(0,t.jsx)(n.code,{children:"Tags"})," column has to use the following format:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'{"CostCenter": "1234","Cost department": "Marketing","env": "prod","org": "trey","Project": "Foo"}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"go version v1.21.0+"}),"\n",(0,t.jsx)(n.li,{children:"docker version 17.03+."}),"\n",(0,t.jsx)(n.li,{children:"kubectl version v1.11.3+."}),"\n",(0,t.jsx)(n.li,{children:"Access to a Kubernetes v1.11.3+ cluster."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"installation-with-helm",children:"Installation with HELM"}),"\n",(0,t.jsxs)(n.p,{children:["The operator can be installed through its ",(0,t.jsx)(n.a,{href:"https://github.com/krateoplatformops/finops-operator-exporter-chart",children:"Helm chart"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"dependencies",children:"Dependencies"}),"\n",(0,t.jsx)(n.p,{children:"To run this repository in your Kubernetes cluster, you need to install the following Krateo Composable FinOps components"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"prometheus-exporter-generic"}),"\n",(0,t.jsx)(n.li,{children:"prometheus-scraper-generic"}),"\n",(0,t.jsx)(n.li,{children:"operator-scraper"}),"\n",(0,t.jsx)(n.li,{children:"prometheus-resource-exporter-azure"}),"\n",(0,t.jsx)(n.li,{children:"finops-database-handler"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Additionally, you need to have a working CrateDB instance to store the scraped data."}),"\n",(0,t.jsx)(n.h3,{id:"bearer-token-for-azure",children:"Bearer-token for Azure"}),"\n",(0,t.jsx)(n.p,{children:"In order to invoke Azure API, the exporter needs to be authenticated first. In the current implementation, it utilizes the Azure REST API, which require the bearer-token for authentication. For each target Azure subscription, an application needs to be registered and assigned with the Cost Management Reader role."}),"\n",(0,t.jsx)(n.p,{children:"Once that is completed, run the following command to obtain the bearer-token (1h validity):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"curl -X POST -d 'grant_type=client_credentials&client_id=<CLIENT_ID>&client_secret=<CLIENT_SECRET>&resource=https%3A%2F%2Fmanagement.azure.com%2F' https://login.microsoftonline.com/<TENANT_ID>/oauth2/token\n"})})]})}function d(e={}){const{wrapper:n}={...(0,o.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},1592:(e,n,r)=>{r.d(n,{c:()=>t});const t=r.p+"assets/images/KCF-operator-exporter-830dc069884adc6a42054184536c65af.png"},2172:(e,n,r)=>{r.d(n,{I:()=>s,M:()=>a});var t=r(1504);const o={},i=t.createContext(o);function a(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);