"use strict";(self.webpackChunkkrateo_v_2_docs=self.webpackChunkkrateo_v_2_docs||[]).push([[3768],{5596:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var t=i(7624),s=i(2172);const o={},r="Real-world Examples of RestDefinition Manifests",a={id:"key-concepts/kog/oasgen-provider-real-examples",title:"Real-world Examples of RestDefinition Manifests",description:"This document provides real-world examples of RestDefinition manifests used with the OASGen Provider. These examples illustrate various use cases and configurations to help users understand how to create their own RestDefinition resources effectively and leverage all the features provided by the OASGen Provider and the Rest Dynamic Controller.",source:"@site/docs/20-key-concepts/40-kog/12-oasgen-provider-real-examples.md",sourceDirName:"20-key-concepts/40-kog",slug:"/key-concepts/kog/oasgen-provider-real-examples",permalink:"/key-concepts/kog/oasgen-provider-real-examples",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:12,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Krateo Operator Generator (KOG) Usage Guide",permalink:"/key-concepts/kog/oasgen-provider-cheatsheet"},next:{title:"rest-dynamic-controller",permalink:"/key-concepts/kog/rest-dynamic-controller"}},d={},c=[{value:"<code>requestFieldMapping</code> Example 1",id:"requestfieldmapping-example-1",level:2},{value:"<code>requestFieldMapping</code> Example 2 + dot escape in <code>excludedSpecFields</code>",id:"requestfieldmapping-example-2--dot-escape-in-excludedspecfields",level:2},{value:"<code>identifiersMatchPolicy</code> with AND",id:"identifiersmatchpolicy-with-and",level:2}];function l(e){const n={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,s.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"real-world-examples-of-restdefinition-manifests",children:"Real-world Examples of RestDefinition Manifests"}),"\n",(0,t.jsxs)(n.p,{children:["This document provides real-world examples of ",(0,t.jsx)(n.code,{children:"RestDefinition"})," manifests used with the OASGen Provider. These examples illustrate various use cases and configurations to help users understand how to create their own ",(0,t.jsx)(n.code,{children:"RestDefinition"})," resources effectively and leverage all the features provided by the OASGen Provider and the Rest Dynamic Controller."]}),"\n",(0,t.jsxs)(n.h2,{id:"requestfieldmapping-example-1",children:[(0,t.jsx)(n.code,{children:"requestFieldMapping"})," Example 1"]}),"\n",(0,t.jsxs)(n.p,{children:["Example showing how to use ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," to map fields from the Custom Resource to different locations in the HTTP request (query parameters, path parameters, request body).\nThis is particularly useful when the field names in the OpenAPI Specification differ from those in the Custom Resource or when fields need to be placed in specific parts of the request."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Resource"}),": ArubaCloud Subnet\n",(0,t.jsx)(n.strong,{children:"Full manifest"}),":\n",(0,t.jsx)(n.strong,{children:"RestDefinition manifest (partial)"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'kind: RestDefinition\napiVersion: ogen.krateo.io/v1alpha1\nmetadata:\n  name: {{ .Release.Name }}-subnet\nspec:\n  oasPath: configmap://{{ .Release.Namespace }}/{{ .Release.Name }}-subnet/subnet.yaml\n  resourceGroup: arubacloud.ogen.krateo.io\n  resource: \n    kind: Subnet\n    identifiers:\n      - metadata.name\n    additionalStatusFields:\n      - metadata.id\n    excludedSpecFields:\n      - id\n    verbsDescription:\n    - action: findby\n      method: GET\n      path: /projects/{projectId}/providers/Aruba.Network/vpcs/{vpcId}/subnets\n    - action: get\n      method: GET\n      path: /projects/{projectId}/providers/Aruba.Network/vpcs/{vpcId}/subnets/{id}\n      requestFieldMapping:\n        - inPath: id\n          inCustomResource: status.metadata.id\n    - action: create\n      method: POST\n      path: /projects/{projectId}/providers/Aruba.Network/vpcs/{vpcId}/subnets\n    - action: update\n      method: PUT\n      path: /projects/{projectId}/providers/Aruba.Network/vpcs/{vpcId}/subnets/{id}\n      requestFieldMapping:\n        - inPath: id\n          inCustomResource: status.metadata.id\n    - action: delete\n      method: DELETE\n      path: /projects/{projectId}/providers/Aruba.Network/vpcs/{vpcId}/subnets/{id}\n      requestFieldMapping:\n        - inPath: id\n          inCustomResource: status.metadata.id\n    configurationFields:\n    - fromOpenAPI:\n        name: api-version\n        in: query\n      fromRestDefinition:\n        actions: ["*"] # star means all actions set in the verbsDescription above\n    - fromOpenAPI:\n        name: filter\n        in: query\n      fromRestDefinition:\n        actions:\n          - findby\n    ...\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Description"}),":\nIn this example, the ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," is used in the ",(0,t.jsx)(n.code,{children:"get"}),", ",(0,t.jsx)(n.code,{children:"update"}),", and ",(0,t.jsx)(n.code,{children:"delete"})," actions to map the ",(0,t.jsx)(n.code,{children:"id"})," path parameter from the Custom Resource's ",(0,t.jsx)(n.code,{children:"status.metadata.id"})," field. This allows the controller to correctly populate the path parameter when making requests to the ArubaCloud API, even though the field is nested.\nIndeed, the OASGen Provider at CRD generation time would add, among others, all the path parameters defined in the endpoints listed in the RestDefinition to the spec of the CRD. In this case, the ",(0,t.jsx)(n.code,{children:"id"})," path parameter would be added to the spec.\nWithout ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," setup, Rest Dynamic Controller would look for an ",(0,t.jsx)(n.code,{children:"id"})," (since the path parameter is ",(0,t.jsx)(n.code,{children:"id"}),") field directly in the spec or status, which does not exist.\nThe field we are looking for is actually ",(0,t.jsx)(n.code,{children:"metadata.id"})," inside the ",(0,t.jsx)(n.code,{children:"status"})," section of the Custom Resource. The field is there because it is listed under ",(0,t.jsx)(n.code,{children:"additionalStatusFields"})," in the RestDefinition.\nTherefore, we need to use ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," to tell the controller where to find the value for the ",(0,t.jsx)(n.code,{children:"id"})," path parameter in the Custom Resource since it is not directly available as ",(0,t.jsx)(n.code,{children:"id"})," in the spec or status due to the nested structure."]}),"\n",(0,t.jsxs)(n.h2,{id:"requestfieldmapping-example-2--dot-escape-in-excludedspecfields",children:[(0,t.jsx)(n.code,{children:"requestFieldMapping"})," Example 2 + dot escape in ",(0,t.jsx)(n.code,{children:"excludedSpecFields"})]}),"\n",(0,t.jsxs)(n.p,{children:["Example showing how to use ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," to map fields from the Custom Resource to different locations in the HTTP request (query parameters, path parameters, request body) and how to escape special characters in ",(0,t.jsx)(n.code,{children:"excludedSpecFields"})," for fields with names including dots (edge case)."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Resource"}),": Azure DevOps PullRequest\n",(0,t.jsx)(n.strong,{children:"Full manifest"}),":\n",(0,t.jsx)(n.strong,{children:"RestDefinition manifest (partial)"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'kind: RestDefinition\napiVersion: ogen.krateo.io/v1alpha1\nmetadata:\n  name: {{ .Release.Name }}-pullrequest\nspec:\n  oasPath: configmap://{{ .Release.Namespace }}/{{ .Release.Name }}-pullrequest/pullrequest.yaml\n  resourceGroup: azuredevops.ogen.krateo.io\n  resource:\n    kind: PullRequest\n    identifiers:\n    - title # Title is enough since the `findby` action supports query filtering\n    additionalStatusFields:\n    - closedBy\n    - closedDate\n    ...\n    excludedSpecFields:\n    - pullRequestId\n    - maxCommentLength\n    - $skip        \n    - $top\n    - completionOptions.triggeredByAutoComplete\n    - \'["searchCriteria.creatorId"]\'\n    - \'["searchCriteria.includeLinks"]\'\n    - \'["searchCriteria.maxTime"]\'\n    - \'["searchCriteria.minTime"]\'\n    - \'["searchCriteria.queryTimeRangeType"]\'\n    - \'["searchCriteria.repositoryId"]\'\n    - \'["searchCriteria.reviewerId"]\'\n    - \'["searchCriteria.sourceRefName"]\'\n    - \'["searchCriteria.sourceRepositoryId"]\'\n    - \'["searchCriteria.status"]\'\n    - \'["searchCriteria.targetRefName"]\'\n    - \'["searchCriteria.title"]\'\n    ...\n    verbsDescription:\n    - action: findby\n      method: GET\n      path: /{organization}/{project}/_apis/git/repositories/{repositoryId}/pullrequests\n      requestFieldMapping:\n        - inQuery: \'["searchCriteria.sourceRefName"]\'\n          inCustomResource: spec.sourceRefName\n        - inQuery: \'["searchCriteria.targetRefName"]\'\n          inCustomResource: spec.targetRefName\n        - inQuery: \'["searchCriteria.title"]\'\n          inCustomResource: spec.title\n    - action: get\n      method: GET\n      path: /{organization}/{project}/_apis/git/repositories/{repositoryId}/pullrequests/{pullRequestId}\n    - action: create\n      method: POST\n      path: /{organization}/{project}/_apis/git/repositories/{repositoryId}/pullrequests\n    - action: update\n      method: PATCH\n      path: /api/{organization}/{project}/git/repositories/{repositoryId}/pullrequests/{pullRequestId} # Plugin endpoint\n      requestFieldMapping:\n        - inBody: lastMergeSourceCommit # this is needed otherwise the update fails in case of status change to `completed`\n          inCustomResource: status.lastMergeSourceCommit\n    # DELETE method is not supported for Pull Requests in Azure DevOps, set the status field of the spec to "abandoned" instead\n    configurationFields:\n    # Common among all actions\n    - fromOpenAPI:\n        name: api-version\n        in: query\n      fromRestDefinition:\n        actions: ["*"]\n    # Get\n    - fromOpenAPI:\n        name: includeCommits\n        in: query\n      fromRestDefinition:\n        actions: \n          - get\n    - fromOpenAPI:\n        name: includeWorkItemRefs\n        in: query\n      fromRestDefinition:\n        actions: \n          - get\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Description"}),":\nIn this example, the ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," is used in both the ",(0,t.jsx)(n.code,{children:"findby"})," and ",(0,t.jsx)(n.code,{children:"update"})," actions to map fields from the Custom Resource to the appropriate locations in the HTTP request. Additionally, special characters in field names are properly escaped in the ",(0,t.jsx)(n.code,{children:"excludedSpecFields"})," section to ensure correct parsing. The notation with brackets and quotes is used to escape the dots in field names.\nNote the difference between the following:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"    - completionOptions.triggeredByAutoComplete\n    - '[\"searchCriteria.creatorId\"]'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The first line does not need escaping since ",(0,t.jsx)(n.code,{children:"completionOptions"})," is an object and ",(0,t.jsx)(n.code,{children:"triggeredByAutoComplete"})," is one of its fields.\nThe second line with ",(0,t.jsx)(n.code,{children:"searchCriteria.creatorId"})," needs escaping since ",(0,t.jsx)(n.code,{children:"searchCriteria"})," is not an object with field ",(0,t.jsx)(n.code,{children:"creatorId"}),", but rather a single field name including a dot (unusual but possible).\nNote that in ",(0,t.jsx)(n.code,{children:"excludedSpecFields"}),", we list some fields that are actually mapped via ",(0,t.jsx)(n.code,{children:"requestFieldMapping"}),". This is because we want to avoid having these fields in the spec which would clutter it with duplicated information. Instead we want to use the already existing fields in the spec and map them to the appropriate locations in the request.\nTherefore ",(0,t.jsx)(n.code,{children:"requestFieldMapping"})," and ",(0,t.jsx)(n.code,{children:"excludedSpecFields"})," can be used together to achieve the desired mapping while keeping the spec clean from redundant fields."]}),"\n",(0,t.jsxs)(n.h2,{id:"identifiersmatchpolicy-with-and",children:[(0,t.jsx)(n.code,{children:"identifiersMatchPolicy"})," with AND"]}),"\n",(0,t.jsxs)(n.p,{children:["Example showing how to use ",(0,t.jsx)(n.code,{children:"identifiersMatchPolicy"})," set to ",(0,t.jsx)(n.code,{children:"AND"})," for the ",(0,t.jsx)(n.code,{children:"findby"})," action to require multiple fields to match when identifying a resource."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Resource"}),": Azure DevOps PolicyConfiguration\n",(0,t.jsx)(n.strong,{children:"Full manifest"}),":\n",(0,t.jsx)(n.strong,{children:"RestDefinition manifest (partial)"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'kind: RestDefinition\napiVersion: ogen.krateo.io/v1alpha1\nmetadata:\n  name: {{ .Release.Name }}-policyconfiguration\nspec:\n  oasPath: configmap://{{ .Release.Namespace }}/{{ .Release.Name }}-policyconfiguration/policyconfiguration.yaml\n  resourceGroup: azuredevops.ogen.krateo.io\n  resource:\n    kind: PolicyConfiguration\n    identifiers:\n    - type.id\n    - settings\n    additionalStatusFields:\n    - id\n    excludedSpecFields:\n    - id\n    - scope # legacy, deprecated field. `scope` in `settings` should be used instead\n    verbsDescription:\n    - action: findby\n      method: GET\n      path: /{organization}/{project}/_apis/policy/configurations\n      identifiersMatchPolicy: AND\n    - action: get\n      method: GET\n      path: /{organization}/{project}/_apis/policy/configurations/{id}\n    - action: create\n      method: POST\n      path: /{organization}/{project}/_apis/policy/configurations\n    - action: update\n      method: PUT\n      path: /{organization}/{project}/_apis/policy/configurations/{id}\n    - action: delete\n      method: DELETE\n      path: /{organization}/{project}/_apis/policy/configurations/{id}\n    configurationFields:\n    # Common among all actions\n    - fromOpenAPI:\n        name: api-version\n        in: query\n      fromRestDefinition:\n        actions: ["*"]\n    # FindBy\n    - fromOpenAPI:\n        name: $top\n        in: query\n      fromRestDefinition:\n        actions:\n          - findby\n    - fromOpenAPI:\n        name: continuationToken\n        in: query\n      fromRestDefinition:\n        actions:\n          - findby\n    - fromOpenAPI:\n        name: policyType\n        in: query\n      fromRestDefinition:\n        actions:\n          - findby\n\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Description"}),":\nIn this example, the ",(0,t.jsx)(n.code,{children:"identifiersMatchPolicy"})," is set to ",(0,t.jsx)(n.code,{children:"AND"})," for the ",(0,t.jsx)(n.code,{children:"findby"})," action. This means that when searching for a ",(0,t.jsx)(n.code,{children:"PolicyConfiguration"})," resource, both the ",(0,t.jsx)(n.code,{children:"type.id"})," and ",(0,t.jsx)(n.code,{children:"settings"})," fields must match the corresponding fields in the API response for a resource to be considered a match. This is useful when multiple fields are required to uniquely identify a resource. The default behavior is ",(0,t.jsx)(n.code,{children:"OR"}),", which would consider a match if any of the specified identifiers match but in this particular case both identifiers are necessary to uniquely identify the resource."]})]})}function p(e={}){const{wrapper:n}={...(0,s.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},2172:(e,n,i)=>{i.d(n,{I:()=>a,M:()=>r});var t=i(1504);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);