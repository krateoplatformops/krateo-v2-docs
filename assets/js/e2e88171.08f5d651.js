"use strict";(self.webpackChunkkrateo_v_2_docs=self.webpackChunkkrateo_v_2_docs||[]).push([[9804],{4008:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var s=t(7624),a=t(2172);const o={},i="finops-database-handler",r={id:"key-concepts/kcf/finops-components/finops-database-handler",title:"finops-database-handler",description:"This service offers a set of endpoints to connect to the Krateo's CrateDB instance and use notebooks to compute data starting from SQL queries.",source:"@site/docs/20-key-concepts/30-kcf/20-finops-components/40-finops-database-handler.md",sourceDirName:"20-key-concepts/30-kcf/20-finops-components",slug:"/key-concepts/kcf/finops-components/finops-database-handler",permalink:"/key-concepts/kcf/finops-components/finops-database-handler",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:40,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"finops-operator-focus",permalink:"/key-concepts/kcf/finops-components/finops-operator-focus"},next:{title:"finops-database-handler-uploader",permalink:"/key-concepts/kcf/finops-components/finops-database-handler-uploader"}},d={},c=[{value:"Summary",id:"summary",level:2},{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"API",id:"api",level:2},{value:"Examples",id:"examples",level:2},{value:"API",id:"api-1",level:3},{value:"Notebooks",id:"notebooks",level:3},{value:"Querying the data",id:"querying-the-data",level:3},{value:"Installation",id:"installation",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.M)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"finops-database-handler",children:"finops-database-handler"}),"\n",(0,s.jsx)(n.p,{children:"This service offers a set of endpoints to connect to the Krateo's CrateDB instance and use notebooks to compute data starting from SQL queries."}),"\n",(0,s.jsxs)(n.p,{children:["This service requires ",(0,s.jsx)(n.a,{href:"https://github.com/crate/",children:"CrateDB"})," to be installed in the Kubernetes cluster."]}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#overview",children:"Overview"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#architecture",children:"Architecture"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#api",children:"API"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#examples",children:"Examples"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"#Installation",children:"Installation"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"This webservice acts as a proxy for all requests to the database, including the possibility of performing computations on the stored data.\nThe structure is: the database requires username/password authentication for the HTTP endpoint. The password is stored in a Kubernetes secret.\nThe RBAC to the secret should allow to filter who can access the webservice-database functionality.\nThe handler calls the database HTTP endpoint to perform queries (both input and output).\nThe result is returned by the endpoint."}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"Krateo Composable FinOps Database Handler",src:t(1695).c+"",width:"669",height:"469"})}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,s.jsx)(n.p,{children:"All endpoints must have the basic auth header field compiled with the username and password of the database. The password can also be a base64 encoded string. Note: if you pass a base64 string you will find a warning in the log that notifies a failed connection attempt: this is expected."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["POST    ",(0,s.jsx)(n.code,{children:"/upload"}),": the webservice receives the data (divided into chunks) and directly uploads it into the specified table in the database"]}),"\n",(0,s.jsxs)(n.li,{children:["POST    ",(0,s.jsx)(n.code,{children:"/compute/<compute_name>"}),": calls the specified compute notebook with the POST body data being the parameters required by the given algorithm, encoded in JSON as parameter_name=parameter_value"]}),"\n",(0,s.jsxs)(n.li,{children:["POST    ",(0,s.jsx)(n.code,{children:"/compute/<compute_name>/upload?overwrite=[true|false]"}),": uploads the specified notebook into the database with the name ",(0,s.jsx)(n.code,{children:"compute_name"}),", with overwriting if configured (if not, defaults to no overwrite)"]}),"\n",(0,s.jsxs)(n.li,{children:["DELETE  ",(0,s.jsx)(n.code,{children:"/compute/<compute_name>"}),": deletes the specified notebook from the database"]}),"\n",(0,s.jsxs)(n.li,{children:["GET     ",(0,s.jsx)(n.code,{children:"/compute/list"}),": lists all available compute notebooks"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"The response of each endpoint will be in the format:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{"result":<result message>}\n'})}),"\n",(0,s.jsx)(n.p,{children:"except for the compute endpoint, which does not have a pre-defined format. This allows the output to be completely customized to the necessities of the application."}),"\n",(0,s.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,s.jsx)(n.h3,{id:"api-1",children:"API"}),"\n",(0,s.jsx)(n.p,{children:"Upload endpoint:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'curl -X POST -u <db-user>:<db-password> http://finops-database-handler.finops:8088/upload?table=<table_name>&type=<cost|resource> -d "<metrics>"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Compute endpoint:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'curl -X POST -u <db-user>:<db-password> http://finops-database-handler.finops:8088/compute/cyclic \\\n    --header "Content-Type: application/json" \\\n    --data \'{"table_name":"testfocus_res"}\'\n'})}),"\n",(0,s.jsx)(n.p,{children:"Compute endpoint upload:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'curl -X POST -u <db-user>:<db-password> http://finops-database-handler.finops:8088/compute/cyclic/upload?overwrite=false --data-binary "@cyclic.py"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For notebook examples, see ",(0,s.jsx)(n.code,{children:"./notebook_samples/cyclic.py"})," or ",(0,s.jsx)(n.code,{children:"./notebook_samples/query.py"})]}),"\n",(0,s.jsx)(n.p,{children:"Compute endpoint list:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"curl -u <db-user>:<db-password> http://finops-database-handler.finops:8088/compute/list\n"})}),"\n",(0,s.jsx)(n.p,{children:"Compute endpoit delete:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"curl -X DELETE -u <db-user>:<db-password> http://finops-database-handler.finops:8088/compute/cyclic\n"})}),"\n",(0,s.jsx)(n.h3,{id:"notebooks",children:"Notebooks"}),"\n",(0,s.jsxs)(n.p,{children:["The notebooks are an agnostic and standalone component. They can be used to integrate additional actions in the database, including an API endpoint for data output. See the folder ",(0,s.jsx)(n.code,{children:"notebook_sample"})," for examples."]}),"\n",(0,s.jsx)(n.p,{children:"The code of each notebook is injected with the authentication information to CrateDB:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"import sys\nfrom crate import client\ndef eprint(*args, **kwargs):\n    print(*args, file=sys.stderr, **kwargs)\nhost = sys.argv[1]\nport = sys.argv[2]\nusername = sys.argv[3]\npassword = sys.argv[4]\ntry:\n    connection = client.connect(f\"http://{host}:{port}\", username=username, password=password)\n    cursor = connection.cursor()\nexcept Exception as e:\n    eprint('error while connecting to database' + str(e))\n    raise\n"})}),"\n",(0,s.jsx)(n.p,{children:"Additionally, you have to conclude the execution of your code by closing the connection and cursor:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"cursor.close()\nconnection.close()\n"})}),"\n",(0,s.jsx)(n.p,{children:"To install additional dependencies inside your notebooks, you need to launch pip at runtime. For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"import pip._internal as pip\ndef install(package):\n    pip.main(['install', package])\n...\nif __name__ == \"__main__\":\n    try:\n        import requests\n    except ImportError:\n        install('requests')\n        import requests\n    ...\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To install notebooks, you can use the dedicated operator and custom resource, see ",(0,s.jsx)(n.a,{href:"https://github.com/krateoplatformops/finops-database-handler-uploader",children:"finops-database-handler-uploader"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"querying-the-data",children:"Querying the data"}),"\n",(0,s.jsx)(n.p,{children:"The Tags in the CSV data read by the exporters need to be in the following format::"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'{"CostCenter": "1234","Cost department": "Marketing","env": "prod","org": "trey","Project": "Foo"}\n'})}),"\n",(0,s.jsx)(n.p,{children:"If this formatting is not used, the finops-database-handler will not insert the data into the database.\nTo query the data using the information present inside the tags, you can use a query like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"SELECT resourceid\nFROM \"doc\".\"focus_table\"\nWHERE tags['org'] = 'test'\n"})}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsxs)(n.p,{children:["The webservice can be installed through the ",(0,s.jsx)(n.a,{href:"https://github.com/krateoplatformops/finops-database-handler-chart",children:"HELM chart"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"helm repo add krateo https://charts.krateo.io\nhelm repo update krateo\nhelm install finops-database-handler krateo/finops-database-handler\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You need to configure the environment variables ",(0,s.jsx)(n.code,{children:"CRATE_HOST"})," and ",(0,s.jsx)(n.code,{children:"CRATE_PORT"})," in the HELM chart of the webservice to connect to the database on the HTTP endpoint of CrateDB."]})]})}function h(e={}){const{wrapper:n}={...(0,a.M)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},1695:(e,n,t)=>{t.d(n,{c:()=>s});const s=t.p+"assets/images/finops-database-handler-architecture-23ed9a6d00ff995d39f8aae3bc694164.png"},2172:(e,n,t)=>{t.d(n,{I:()=>r,M:()=>i});var s=t(1504);const a={},o=s.createContext(a);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);