"use strict";(self.webpackChunkkrateo_v_2_docs=self.webpackChunkkrateo_v_2_docs||[]).push([[2832],{4672:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var r=t(7624),o=t(2172);const i={},a="finops-operator-exporter",s={id:"key-concepts/kcf/finops-components/finops-operator-exporter",title:"finops-operator-exporter",description:"This repository is part of the wider exporting architecture for the Krateo Composable FinOps and manages the exporting from API endpoints of FOCUS cost reports.",source:"@site/docs/20-key-concepts/30-kcf/20-finops-components/10-finops-operator-exporter.md",sourceDirName:"20-key-concepts/30-kcf/20-finops-components",slug:"/key-concepts/kcf/finops-components/finops-operator-exporter",permalink:"/key-concepts/kcf/finops-components/finops-operator-exporter",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Introduction",permalink:"/key-concepts/kcf/finops-introduction"},next:{title:"finops-operator-scraper",permalink:"/key-concepts/kcf/finops-components/finops-operator-scraper"}},c={},l=[{value:"Summary",id:"summary",level:2},{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Examples",id:"examples",level:2},{value:"Example Use Case",id:"example-use-case",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Installation with HELM",id:"installation-with-helm",level:3},{value:"Dependencies",id:"dependencies",level:3},{value:"Bearer-token for Azure",id:"bearer-token-for-azure",level:3}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.M)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"finops-operator-exporter",children:"finops-operator-exporter"}),"\n",(0,r.jsx)(n.p,{children:"This repository is part of the wider exporting architecture for the Krateo Composable FinOps and manages the exporting from API endpoints of FOCUS cost reports."}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#overview",children:"Overview"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#architecture",children:"Architecture"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#examples",children:"Examples"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"#configuration",children:"Configuration"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(n.p,{children:'This finops-operator-exporter is tasked with the creation of a generic exporting pipeline, according to the description given in a Custom Resource (CR). After the creation of the CR, the operator reads the "exporting" configuration and creates three resources: a deployment with a generic prometheus exporter inside, a configmap containing the exporter configuration CR and a service that exposes the deployment. The given endpoint is supposed to be a CSV file containing a FOCUS report. Then, it creates a new CR for the FinOps Operator Scraper, which starts a generic scraper to upload the data to a database. The configmap is mounted as a volume inside the deployment and the service is used to expose the metrics collected by the exporter in the prometheus format.'}),"\n",(0,r.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Krateo Composable FinOps Operator Exporter",src:t(2108).c+"",width:"1975",height:"683"})}),"\n",(0,r.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: finops.krateo.io/v1\nkind: DatabaseConfig\nmetadata:\n  name: # DatabaseConfig name\n  namespace: # DatabaseConfig namespace\nspec:\n  username: # username string\n  passwordSecretRef: # object reference to secret with password\n    name: # secret name\n    namespace: # secret namespace\n    key: # secret key\n---\napiVersion: finops.krateo.io/v1\nkind: ExporterScraperConfig\nmetadata:\n  name: # ExporterScraperConfig name\n  namespace: # ExporterScraperConfig namespace\nspec:\n  exporterConfig: # same as krateoplatformops/finops-prometheus-exporter-generic\n    api: # the API to call\n      path: # the path inside the domain\n      verb: GET # the method to call the API with\n      endpointRef: # secret with the url in the format http(s)://host:port, it can contain variables, such as http://<varName>.com:<envExample>, which will be compiled with the additionalVariables fields\n        name: \n        namespace:\n    # metricType: # optional, one of: cost, resource, generic; default value: cost\n    # generic: # option, required if metric type is generic\n    #  valueColumnIndex: # index of the metric value\n    #  metricName: # name to use for the metric in prometheus\n    pollingInterval: # time duration, e.g., 12h30m\n    additionalVariables:\n      varName: sample\n      # Variables whose value only contains uppercase letters are taken from environment variables\n      # FROM_THE_ENVIRONMENT must be the name of an environment variable inside the target exporter container (e.g., kubernetes services)\n      envExample: FROM_THE_ENVIRONMENT\n  scraperConfig: # same fields as krateoplatformops/finops-prometheus-scraper-generic\n    tableName: # tableName in the database to upload the data to\n    # api: # api to the exporter, optional (if missing, it uses the exporter)\n    pollingInterval: # time duration, e.g., 12h30m\n    scraperDatabaseConfigRef: # See above kind DatabaseConfig\n      name: # name of the databaseConfigRef CR \n      namespace: # namespace of the databaseConfigRef CR\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If the field ",(0,r.jsx)(n.code,{children:"metricType"})," is set to ",(0,r.jsx)(n.code,{children:"cost"}),", then the API in ",(0,r.jsx)(n.code,{children:"url"})," must expose a FOCUS report in a CSV file. Otherwise, if set to ",(0,r.jsx)(n.code,{children:"resource"}),", it must expose usage metrics according to the JSON/OPENAPI schema in the folder resources and the field ",(0,r.jsx)(n.code,{children:"additionalVariables"})," must contain a field ",(0,r.jsx)(n.code,{children:"ResourceId"})," with the identifier of the resources to be used in the database as external key to reference the cost metric from the usage metric (i.e., the same as the field ",(0,r.jsx)(n.code,{children:"resourceId"})," of the focusConfig CR)."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"metricType"})," ",(0,r.jsx)(n.code,{children:"generic"})," removes checks on the schema, allowing for the upload of arbitrary data. However, there is still the need to point out which field is the data point and what is the name of the metric:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["the ",(0,r.jsx)(n.code,{children:"valueColumnIndex"})," tells us which field will be the metric value: for CSV its the column index, for JSON its the index for all the keys sorted alphabetically for all the objects."]}),"\n",(0,r.jsxs)(n.li,{children:["the ",(0,r.jsx)(n.code,{children:"metricName"})," instead allows to specify a name for the metric, which will also be used by the scraper to select only a specific metric if the type is generic (e.g., exporting/scraping from a prometheus endpoint with many metrics)"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Additionally, this feature will be used to upload metrics in the Prometheus API format, allowing the use of the Prometheus Exporting Stack for pods, nodes, etc. inside the cluster and not relying on external data coming from service providers."}),"\n",(0,r.jsx)(n.p,{children:"The configuration for the Prometheus API looks like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: finops.krateo.io/v1\nkind: ExporterScraperConfig\nmetadata:\n  name: exporterscraperconfig-sample\n  namespace: krateo-system\nspec:\n  exporterConfig:\n    api: \n      path: /api/v1/query?query=container_cpu_usage_seconds_total\n      verb: GET\n      endpointRef:\n        name: promethes-endpoint\n        namespace: prom-system\n    metricType: generic\n    generic:\n      valueColumnIndex: 14\n      metricName: cpu\n    pollingInterval: "1m"\n  scraperConfig:\n    pollingInterval: "1m"\n    tableName: testprom\n    scraperDatabaseConfigRef:\n      name: finops-database-handler\n      namespace: krateo-system\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: promethes-endpoint\n  namespace: prom-system\nstringData:\n  server-url: http://kind-prometheus-kube-prome-prometheus.monitoring.svc:9090\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The field ",(0,r.jsx)(n.code,{children:"spec.scraperConfig.api"})," can be left empty if the exporter and scraper are both configured. The operator will compile this field automatically."]}),"\n",(0,r.jsx)(n.h3,{id:"example-use-case",children:"Example Use Case"}),"\n",(0,r.jsx)(n.p,{children:"The Composable FinOps can be used to display pricing, costs and optimizations in the Krateo Composable Portal through a dedicated blueprint. You can find out more here:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/krateoplatformops-blueprints/azure-vm-finops",children:"azure-vm-finops"}),"."]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://github.com/krateoplatformops-blueprints/azure-compute-optimization-toolkit",children:"azure-compute-optimization-toolkit"})}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(n.p,{children:"To start the exporting process, see the examples section. The configuration sample includes the database-config CR."}),"\n",(0,r.jsxs)(n.p,{children:["The exporter container is created in the namespace of the CR. The exporter container looks for a secret in the CR namespace called ",(0,r.jsx)(n.code,{children:"registry-credentials"}),", configurable in the HELM chart."]}),"\n",(0,r.jsxs)(n.p,{children:["The FOCUS data needs to be in the CSV format and the ",(0,r.jsx)(n.code,{children:"Tags"})," column has to use the following format:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'{"CostCenter": "1234","Cost department": "Marketing","env": "prod","org": "trey","Project": "Foo"}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"go version v1.21.0+"}),"\n",(0,r.jsx)(n.li,{children:"docker version 17.03+."}),"\n",(0,r.jsx)(n.li,{children:"kubectl version v1.11.3+."}),"\n",(0,r.jsx)(n.li,{children:"Access to a Kubernetes v1.11.3+ cluster."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"installation-with-helm",children:"Installation with HELM"}),"\n",(0,r.jsxs)(n.p,{children:["The operator can be installed through its ",(0,r.jsx)(n.a,{href:"https://github.com/krateoplatformops/finops-operator-exporter-chart",children:"Helm chart"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"dependencies",children:"Dependencies"}),"\n",(0,r.jsx)(n.p,{children:"To run this repository in your Kubernetes cluster, you need to install the following Krateo Composable FinOps components"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"prometheus-exporter-generic"}),"\n",(0,r.jsx)(n.li,{children:"prometheus-scraper-generic"}),"\n",(0,r.jsx)(n.li,{children:"operator-scraper"}),"\n",(0,r.jsx)(n.li,{children:"prometheus-resource-exporter-azure"}),"\n",(0,r.jsx)(n.li,{children:"finops-database-handler"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Additionally, you need to have a working CrateDB instance to store the scraped data."}),"\n",(0,r.jsx)(n.h3,{id:"bearer-token-for-azure",children:"Bearer-token for Azure"}),"\n",(0,r.jsx)(n.p,{children:"In order to invoke Azure API, the exporter needs to be authenticated first. In the current implementation, it utilizes the Azure REST API, which require the bearer-token for authentication. For each target Azure subscription, an application needs to be registered and assigned with the Cost Management Reader role."}),"\n",(0,r.jsx)(n.p,{children:"Once that is completed, run the following command to obtain the bearer-token (1h validity):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"curl -X POST -d 'grant_type=client_credentials&client_id=<CLIENT_ID>&client_secret=<CLIENT_SECRET>&resource=https%3A%2F%2Fmanagement.azure.com%2F' https://login.microsoftonline.com/<TENANT_ID>/oauth2/token\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.M)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},2108:(e,n,t)=>{t.d(n,{c:()=>r});const r=t.p+"assets/images/KCF-operator-exporter-830dc069884adc6a42054184536c65af.png"},2172:(e,n,t)=>{t.d(n,{I:()=>s,M:()=>a});var r=t(1504);const o={},i=r.createContext(o);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);